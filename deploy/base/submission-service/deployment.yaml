apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: submission-service
  namespace: default
  labels: { app: submission-service }
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: 2
  selector:
    matchLabels: { app: submission-service }
  template:
    metadata:
      labels: { app: submission-service }
    spec:
      serviceAccountName: submission-service
      volumes:
        - name: app-config
          secret:
            secretName: submission-service-app-yml
      containers:
        - name: submission-service
          image: ghcr.io/mihaicatalin22/questify-submission-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: app-config
              mountPath: /config
              readOnly: true
          env:
            - { name: SPRING_PROFILES_ACTIVE, value: "prod" }
            - { name: SPRING_APPLICATION_NAME, value: "submission-service" }
            - { name: SPRING_CONFIG_ADDITIONAL_LOCATION, value: "/config/" }

            - { name: SERVER_PORT, value: "8080" }
            - { name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE, value: "health,info,prometheus" }
            - { name: MANAGEMENT_HEALTH_PROBES_ENABLED, value: "true" }
            - { name: SPRING_DATASOURCE_URL, value: "jdbc:mysql://mysql:3306/submission?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC" }
            - { name: SPRING_DATASOURCE_USERNAME, value: "root" }
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom: { secretKeyRef: { name: mysql-root, key: password } }

            - { name: SPRING_KAFKA_BOOTSTRAP_SERVERS, value: "questify-kafka-kafka-bootstrap.kafka.svc:9092" }
            - { name: SPRING_KAFKA_CONSUMER_KEY_DESERIALIZER, value: "org.apache.kafka.common.serialization.StringDeserializer" }
            - { name: SPRING_KAFKA_CONSUMER_VALUE_DESERIALIZER, value: "org.springframework.kafka.support.serializer.JsonDeserializer" }
            - { name: SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_JSON_TRUSTED_PACKAGES, value: "*" }
            - { name: SPRING_KAFKA_PROPERTIES_REQUEST_TIMEOUT_MS, value: "8000" }

            - { name: APP_KAFKA_TOPICS_QUESTS, value: "dev.questify.quests" }
            - { name: APP_KAFKA_TOPICS_SUBMISSIONS, value: "dev.questify.submissions" }

            - { name: SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI, value: "https://questify.tail03c40b.ts.net/auth/realms/questify" }

            - { name: JAVA_OPTS, value: "-XX:MaxRAMPercentage=75 -XX:+AlwaysActAsServerClassMachine" }

          startupProbe:
            httpGet: { path: /actuator/health/liveness, port: http }
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 120
          readinessProbe:
            httpGet: { path: /actuator/health/readiness, port: http }
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet: { path: /actuator/health/liveness, port: http }
            initialDelaySeconds: 120
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          resources:
            requests: { cpu: "100m", memory: "256Mi" }
            limits:   { cpu: "500m", memory: "512Mi" }

  strategy:
    canary:
      maxSurge: 1
      maxUnavailable: 0
      steps:
        - setWeight: 20
        - analysis:
            templates:
              - templateName: submission-service-5xx-rate
        - pause:
            duration: 60s

        - setWeight: 50
        - analysis:
            templates:
              - templateName: submission-service-5xx-rate
        - pause:
            duration: 120s

        - setWeight: 100
