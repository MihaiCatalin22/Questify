apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
  namespace: default
  labels: { app: user-service }
  annotations:
    argocd.argoproj.io/sync-options: Replace=true
spec:
  replicas: 1
  selector:
    matchLabels: { app: user-service }
  template:
    metadata:
      labels: { app: user-service }
    spec:
      serviceAccountName: user-service
      volumes:
        - name: app-config
          secret:
            secretName: user-service-app-yml
      containers:
        - name: user-service
          image: ghcr.io/mihaicatalin22/questify-user-service:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: app-config
              mountPath: /config
              readOnly: true
          env:
            - { name: SPRING_PROFILES_ACTIVE, value: "prod" }
            - { name: JAVA_OPTS, value: "-XX:MaxRAMPercentage=75 -XX:+AlwaysActAsServerClassMachine" }
            - { name: SERVER_PORT, value: "8080" }
            - { name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE, value: "health,info,prometheus" }
            - { name: MANAGEMENT_HEALTH_PROBES_ENABLED, value: "true" }
            # MySQL
            - { name: SPRING_DATASOURCE_URL, value: "jdbc:mysql://mysql:3306/questify?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC" }
            - { name: SPRING_DATASOURCE_USERNAME, value: "root" }
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom: { secretKeyRef: { name: mysql-root, key: password } }
            # OIDC JWKS required by user-service
            - { name: OIDC_JWKS, value: "http://keycloak:8080/realms/questify/protocol/openid-connect/certs" }
          startupProbe:
            httpGet: { path: /actuator/health/liveness, port: http, scheme: HTTP }
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 120
          readinessProbe:
            httpGet: { path: /actuator/health/readiness, port: http, scheme: HTTP }
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet: { path: /actuator/health/liveness, port: http, scheme: HTTP }
            initialDelaySeconds: 120
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          resources:
            requests: { cpu: "100m", memory: "256Mi" }
            limits:   { cpu: "500m", memory: "512Mi" }