name: CI

on:
  push:
    branches: ["**"]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      quest:      ${{ steps.filter.outputs.quest }}
      user:       ${{ steps.filter.outputs.user }}
      proof:      ${{ steps.filter.outputs.proof }}
      submission: ${{ steps.filter.outputs.submission }}
      frontend:   ${{ steps.filter.outputs.frontend }}
      common:     ${{ steps.filter.outputs.common }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            quest:
              - 'quest-service/**'
            user:
              - 'user-service/**'
            proof:
              - 'proof-service/**'
            submission:
              - 'submission-service/**'
            frontend:
              - 'frontend/**'
            common:
              - '.github/workflows/**'
              - 'build.gradle*'
              - 'settings.gradle*'
              - 'gradle/**'
              - 'gradlew'
              - 'gradlew.bat'

  quest:
    name: Quest Service • Build & Test
    needs: changes
    if: needs.changes.outputs.quest == 'true' || needs.changes.outputs.common == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build & Test (quest-service)
        run: ./gradlew --no-daemon :quest-service:clean :quest-service:test :quest-service:jacocoTestReport

      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quest-tests
          path: quest-service/build/reports/tests/test/**
          if-no-files-found: ignore

      - name: Upload JaCoCo coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quest-jacoco-xml
          path: quest-service/build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: ignore

  user:
    name: User Service • Build & Test
    needs: changes
    if: needs.changes.outputs.user == 'true' || needs.changes.outputs.common == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Build & Test (user-service)
        run: ./gradlew --no-daemon :user-service:clean :user-service:test :user-service:jacocoTestReport
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-tests
          path: user-service/build/reports/tests/test/**
          if-no-files-found: ignore
      - name: Upload JaCoCo coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: user-jacoco-xml
          path: user-service/build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: ignore

  proof:
    name: Proof Service • Build & Test
    needs: changes
    if: needs.changes.outputs.proof == 'true' || needs.changes.outputs.common == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Build & Test (proof-service)
        run: ./gradlew --no-daemon :proof-service:clean :proof-service:test :proof-service:jacocoTestReport
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proof-tests
          path: proof-service/build/reports/tests/test/**
          if-no-files-found: ignore
      - name: Upload JaCoCo coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proof-jacoco-xml
          path: proof-service/build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: ignore

  submission:
    name: Submission Service • Build & Test
    needs: changes
    if: needs.changes.outputs.submission == 'true' || needs.changes.outputs.common == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate Gradle Wrapper
        uses: gradle/actions/wrapper-validation@v3
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v3
      - name: Make gradlew executable
        run: chmod +x gradlew
      - name: Build & Test (submission-service)
        run: ./gradlew --no-daemon :submission-service:clean :submission-service:test :submission-service:jacocoTestReport
      - name: Upload JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: submission-tests
          path: submission-service/build/reports/tests/test/**
          if-no-files-found: ignore
      - name: Upload JaCoCo coverage xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: submission-jacoco-xml
          path: submission-service/build/reports/jacoco/test/jacocoTestReport.xml
          if-no-files-found: ignore

  frontend:
    name: Frontend • Build
    needs: changes
    if: needs.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload FE build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fe-dist
          path: frontend/dist
          if-no-files-found: ignore
