map \ \ { default upgrade; '' close; }

server {
  listen 80;
  server_name _;

  add_header X-Content-Type-Options nosniff always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header X-XSS-Protection "1; mode=block" always;

  root  /usr/share/nginx/html;
  index index.html;

  client_max_body_size 100m;
  proxy_read_timeout   120s;
  proxy_send_timeout   120s;

  # --- USERS ---
  location = /api/users { proxy_pass http://user-service:8080/users; 
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }
  location /api/users/ { proxy_pass http://user-service:8080/users/;
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }

  # --- QUESTS ---
  location = /api/quests { proxy_pass http://quest-service:8080/quests; 
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }
  location /api/quests/ { proxy_pass http://quest-service:8080/quests/;
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }

  # --- SUBMISSIONS ---
  location = /api/submissions { proxy_pass http://submission-service:8080/submissions; 
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }
  location /api/submissions/ { proxy_pass http://submission-service:8080/submissions/;
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }

  # --- UPLOADS ---
  location = /api/uploads { proxy_pass http://proof-service:8080/uploads;
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }
  location /api/uploads/ { proxy_pass http://proof-service:8080/uploads/;
    proxy_set_header Authorization \;
    proxy_set_header Upgrade \;
    proxy_set_header Connection \;
    proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Real-IP \;
    proxy_set_header X-Forwarded-For \;
    proxy_set_header X-Forwarded-Proto https;
    proxy_hide_header WWW-Authenticate;
    proxy_request_buffering off; proxy_max_temp_file_size 0; proxy_redirect off; proxy_buffering off; }

  # --- Keycloak at /auth (FIXED: no trailing slash) ---
  location ^~ /auth/ {
    proxy_http_version 1.1;
    proxy_pass http://keycloak:8080;   # keep /auth prefix intact
    proxy_set_header Host               \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Forwarded-Host   \System.Management.Automation.Internal.Host.InternalHost;
    proxy_set_header X-Forwarded-Proto  https;
    proxy_set_header X-Forwarded-For    \;
    proxy_set_header X-Forwarded-Prefix /auth;
    proxy_redirect off;
    proxy_buffering off;
  }

  # S3 passthroughs (unchanged)
  location ^~ /s3/               { proxy_http_version 1.1; proxy_pass http://minio:9000/;  proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost; proxy_set_header X-Real-IP \; proxy_set_header X-Forwarded-For \; proxy_set_header X-Forwarded-Proto https; proxy_buffering off; proxy_read_timeout 120s; proxy_send_timeout 120s; proxy_redirect off; }
  location ^~ /questify-proofs/  { proxy_http_version 1.1; proxy_pass http://minio:9000;   proxy_set_header Host \System.Management.Automation.Internal.Host.InternalHost; proxy_set_header X-Real-IP \; proxy_set_header X-Forwarded-For \; proxy_set_header X-Forwarded-Proto https; proxy_buffering off; proxy_redirect off; proxy_read_timeout 120s; proxy_send_timeout 120s; }

  # SPA
  location = /oidc/callback { try_files \ /index.html; }
  location /               { try_files \ \/ /index.html; }
  location = /index.html   { add_header Cache-Control "no-store" always; }

  location ~* \.(?:js|css|png|jpe?g|gif|svg|ico|woff2?|ttf)$ {
    expires 7d; access_log off; try_files \ =404;
  }

  gzip on; gzip_min_length 1024;
  gzip_types text/plain text/css application/json application/javascript application/xml application/xml+rss image/svg+xml font/woff2 font/woff;
}
